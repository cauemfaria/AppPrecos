AppPrecos Django PWA â€“ Deployment Guide
======================================

Local development
-----------------
1. Install Playwright browsers once: `uv run playwright install chromium`
2. Copy env.example to .env and fill Supabase keys:
   - SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, SUPABASE_ANON_KEY
   - DJANGO_SECRET_KEY (use `python -c "import secrets; print(secrets.token_urlsafe(32))"`)
3. Run the dev server: `uv run python manage.py runserver`
4. Access http://localhost:8000/ to use the PWA and QR scanner.

Render deployment
-----------------
1. Ensure your repository contains the `webapp/` directory and `render.yaml` (see below).
2. Push to GitHub and create a new Web Service on Render pointing at the repo.
3. Configure the service with:
   - Root Directory: `webapp`
   - Build Command: `uv sync --frozen && uv run python manage.py collectstatic --noinput`
   - Start Command: `uv run gunicorn app_precos_site.wsgi:application --bind 0.0.0.0:$PORT`
4. Set environment variables in Render dashboard:
   - DJANGO_SECRET_KEY (Generate)
   - DJANGO_DEBUG=false
   - DJANGO_ALLOWED_HOSTS=your-service.onrender.com
   - DJANGO_CSRF_TRUSTED=https://your-service.onrender.com
   - SUPABASE_URL
   - SUPABASE_ANON_KEY
   - SUPABASE_SERVICE_ROLE_KEY
5. Add a background worker (optional) that runs `uv run python manage.py process_nfce_queue`
   if you later move NFC-e extraction to a task queue.

Static assets
-------------
WhiteNoise is enabled, so Render can serve collected static files without extra storage.
Always run `uv run python manage.py collectstatic --noinput` during build (already covered).

Supabase parity checks
----------------------
Use the `/api/schema/validate` endpoint after deployment to verify the tables `markets`,
`purchases`, `unique_products`, and `processed_urls` still contain the required columns.

PWA testing
-----------
1. Run Lighthouse inside Chrome DevTools and verify the PWA checks pass.
2. Test QR scanner on an Android device using Chrome by visiting the Render URL; audio/camera
   permissions must be granted for the html5-qrcode component.

Troubleshooting
---------------
- If `/api/nfce/extract` returns 500, verify Supabase credentials and check Render logs.
- Playwright requires extra dependencies on Linux; Render includes them by default, but
  you can inspect `render-build.sh` to install additional packages if necessary.
- For SSL mixed content issues make sure the Supabase REST endpoints are HTTPS.


